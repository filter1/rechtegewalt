<!DOCTYPE html>
<html lang="de">
    <head>
        <link rel="stylesheet" type="text/css" href="http://cdn.jsdelivr.net/qtip2/2.2.1/jquery.qtip.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta charset="utf-8">
        <meta name="author" content="Johannes Filter">

        <title>Rechte Gewalt in Brandenburg</title>

        <meta name="description" content="Seit 2000 wurden in Brandenburg knapp 1700 Straftaten mit rechtem Hintergrund dokumentiert. Diese Karte gibt einen Überblick.">

        <!-- Twitter Card data -->
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@fil_ter">
        <meta name="twitter:image" content="http://brandenburg.rechtegewalt.com/preview.png">
        <meta name="twitter:url" content="http://brandenburg.rechtegewalt.com/">

        <!-- Open Graph data -->
        <meta property="og:title" content="Rechte Gewalt in Brandenburg" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://brandenburg.rechtegewalt.com/" />
        <meta property="og:image" content="http://brandenburg.rechtegewalt.com/preview.png" />
        <meta property="og:description" content="Seit 2000 wurden in Brandenburg knapp 1700 Straftaten mit rechtem Hintergrund dokumentiert. Diese Karte gibt einen Überblick." />

        <style type="text/css">

            @media screen and (min-width: 992px) {

                html, body, .container-fluid, .row, .col-md-7, .col-md-7 + .col-md-3{
                    height: 100%;
                }
            }

            .fullHeight {
                height: 98%;
                margin: 1% 0;
                overflow: auto;
            }

            a, a:hover {
                color: #333333;
            }

            .bubble:hover {
                stroke-opacity: 0;
            }

            .bubble {
                fill:#800;
                stroke: #fff;
                fill-opacity: 0.5;
                cursor: pointer;',
            }
        </style>

        <script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
        <script src="https://rawgit.com/DmitryBaranovskiy/raphael/master/raphael-min.js"></script>
        <script src="https://rawgit.com/kartograph/kartograph.js/master/dist/kartograph.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
        <script src="http://cdn.jsdelivr.net/qtip2/2.2.1/jquery.qtip.min.js"></script>

    </head>

    <body>
        <script type="text/javascript">
            function fillText(data) {

                $( '#text' ).html('');

                var all = data.allLocations;

                // clustered cities?
                if ( all ) {
                    for ( var i = 0; i < all.length; i++ ) {
                        $( "#text" ).append('<h2>' + all[i].location + ' <small>' + all[i].n +'</small></h2>');
                        fillIncidents( all[i].incidents );
                    }
                } else {
                    $( "#text" ).append('<h2>' + data.location + ' <small>' + data.n +'</small></h2>');
                    fillIncidents( data.incidents )
                }
            };

            function fillIncidents( incidents ) {
                for (var i = incidents.length - 1; i >= 0; i--) {
                    var mydate = new Date(incidents[i].date);
                    $( "#text" ).append( "<p><small>" + mydate.toLocaleDateString('de-DE') + "</small></p>" );
                    $( "#text" ).append( "<p>" + incidents[i].text + "</p>" );
                    $( "#text" ).append( "<p><small>Quelle: " + incidents[i].source + "</small></p><hr>" );
                }
            }

            function sumCities(cities) {
                var total = 0;
                var allLocations = [];
                var bestN = -1;
                var bestLocation;

                $.each(cities, function(i, city) {

                    if ( city.allLocations ) {
                        allLocations = allLocations.concat(city.allLocations);

                        var tempN = city.n;

                        // Hack: It's not correct. ¯\_(ツ)_/¯ 
                        if ( tempN > bestN ) {
                            bestN = tempN;
                            bestLocation = city.location;
                        }

                        total += tempN;
                    } else {
                        allLocations.push(city);
                        total += city.n;

                        if ( city.n > bestN ) {
                            bestN = city.n;
                            bestLocation = city.location;
                        }
                    }
                });

                return {location: bestLocation, n: total, allLocations: allLocations };
            };

            $(function() {
                var mobile = false
                if( $(window).width() <= 992 ){
                    mobile = true;

                    $(' #infoText').append("Weil du mobil unterwegs bist, wurden die Anzahl der Orte reduziert.");
                }

                // initialize tooltips
                $.fn.qtip.defaults.style.classes = 'qtip-light';
                $.fn.qtip.defaults.style.def = false;

                var map = kartograph.map('#map');
                map.loadMap('map.svg', function() {

                    map.addLayer('roads', {
                        styles: {
                            stroke: 'grey',
                            fill: 'white',
                        }
                    });
 
                    $.ajax({
                        url: 'cities.json',
                        dataType: 'json',
                        success: function(cities) {

                            var scale = kartograph.scale.sqrt(cities.concat([{ n: 0 }]), 'n').range([3, 20]);

                            if( mobile ){
                                cities = cities.filter(function (x) {return x.n > 11})
                            }

                            map.addSymbols({
                                type: kartograph.Bubble,
                                data: cities,
                                location: function(city) {
                                    return [city.lng, city.lat];
                                },
                                radius: function(city) {
                                    return scale(city.n);
                                },
                                tooltip: function(city) {

                                    if (city.allLocations) {
                                        return '<h3>' + city.location + '<small> +' + (city.allLocations.length - 1) + '</small>' + '</h3>' + city.n +' Vorfälle'; 
                                    }
                                    return '<h3>'+city.location+'</h3>'+city.n+' Vorfälle';
                                },
                                click: function(data, path, event) {
                                    fillText(data);

                                    if( $(window).width() <= 992 ){
                                        $('html, body').animate({
                                            scrollTop: $("#text").offset().top
                                        }, 2000);
                                    }
                                },
                                clustering: 'noverlap',
                                clusteringOpts: {
                                    tolerance: 0.0,
                                    maxRatio: 1
                                },
                                aggregate: sumCities,
                                sortBy: 'radius desc',
                            });

                            if( mobile ){
                                $('[data-hasqtip]').qtip('hide').qtip('disable');
                            }
                        }
                    });
                });
            });

        </script>
        
        <div class="container-fluid">
            <div class="row">
                <div class="col-xs-18 col-md-2">
                    <div class="page-header">
                      <h1>Rechte Gewalt<br><small>in Brandenburg</small></h1>
                    </div>

                    <br>

                    <div id="infoText">
                        <p>Seit 2000 wurden in Brandenburg knapp 1700 Straftaten mit rechtem Hintergrund dokumentiert.</p>

                        <p>Klick auf die Kreise, um die Bericht der Vorfälle zu lesen.</p>

                        <br><br>

                        <p><small>Daten: <a href="http://www.opferperspektive.de/category/rechte-angriffe/chronologie-rechter-angriffe">Opferperspektive</a></small></p>

                        <p><small>Idee und Umsetzung: <a href="http://johannesfilter.com">Johannes Filter</a></small></p>

                        <p><small>Framework: <a href="http://kartograph.org">Kartograph.js</a></small></p>

                        <p><small>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</small></p>
                        <p><small><a href="http://magdego.de/impressum">Impressum</a></small></p>
                    </div>
                    
                </div>
                <div class="col-xs-18 col-md-7">
                    <div class="fullHeight" id="map">
                    </div>
                </div>
                <div class="col-xs-18 col-md-3">
                    <div class="fullHeight" id="text"></div>
                </div>
            </div>
        </div>
    </body>
</html>